rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check user role
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Helper function to check if user is admin or superadmin
    function isAdmin() {
      return isAuthenticated() && getUserRole() in ['admin', 'superadmin'];
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read their own data
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Users can create their own document on signup
      allow create: if isAuthenticated() && request.auth.uid == userId;
      // Users can update their own data
      allow update: if isAuthenticated() && request.auth.uid == userId;
      // Admins can read and update any user
      allow read, update: if isAdmin();
      // Authenticated users can read company user documents (filtering by verificationStatus happens in app code)
      allow read: if isAuthenticated() && resource.data.role == 'company';
    }
    
    // Contact Support collection
    match /contactSupport/{document} {
      // Anyone can create a contact support request (even unauthenticated users)
      allow create: if true;
      // Only admins can read, update, and delete support requests
      allow read, update, delete: if isAdmin();
    }
    
    // Feedback collection
    match /feedback/{document} {
      // Anyone can create feedback (even unauthenticated users)
      allow create: if true;
      // Only admins can read, update, and delete feedback
      allow read, update, delete: if isAdmin();
    }
    
    // Jobs collection
    match /jobs/{jobId} {
      // Anyone can read jobs
      allow read: if true;
      // Only authenticated users with company role or admins can create jobs
      allow create: if isAuthenticated() && (getUserRole() in ['company', 'admin', 'superadmin']);
      // Only the job creator or admins can update/delete
      allow update, delete: if isAuthenticated() && 
        (resource.data.createdBy == request.auth.uid || getUserRole() in ['admin', 'superadmin']);
    }
    
    // Categories collection
    match /categories/{categoryId} {
      // Anyone can read categories
      allow read: if true;
      // Only admins can create, update, or delete categories
      allow create, update, delete: if isAdmin();
    }
    
    // Telegram Channels collection
    match /telegramChannels/{channelId} {
      // Anyone can read telegram channels
      allow read: if true;
      // Only admins can create, update, or delete channels
      allow create, update, delete: if isAdmin();
    }
    
    // Subscription Plans collection
    match /subscriptionPlans/{planId} {
      // Anyone can read subscription plans
      allow read: if true;
      // Only admins can create, update, or delete plans
      allow create, update, delete: if isAdmin();
    }
    
    // Applications collection (if you have job applications)
    match /applications/{applicationId} {
      // Users can read their own applications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Users can create applications
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Companies and admins can read applications for their jobs
      allow read: if isAuthenticated() && (getUserRole() in ['company', 'admin', 'superadmin']);
      // Only admins can update or delete applications
      allow update, delete: if isAdmin();
    }
    
    // Bookmarks collection (if you store bookmarks)
    match /bookmarks/{userId} {
      // Users can read and write their own bookmarks
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
  }
}
